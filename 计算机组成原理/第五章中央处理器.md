
# CPU的功能和基本结构

### CPU的功能
CPU组成：

- 运算器：对数据进行加工
- 控制器：包括取指令、分析指令和执行指令

CPU功能：

- 指令控制
- 操作控制
- 时间控制
- 数据加工
- 中断处理

### CPU的基本结构

- 运算器：运算器接收从控制器送来的命令并执行相应的动作，对数据进行加工和处理。
  - 算术逻辑单元(ALU)：主要功能是进行算数\逻辑运算。
  - 暂存寄存器：用于暂存从主存读来的数据，该数据不能存放在通用寄存器中，否则会破坏原有内容。暂存寄存器对应用程序员透明。
  - 累加寄存器：通用寄存器，用于暂存ALU运算的结果，可以作为加法运算的一个输入端。
  - 通用寄存器组：AX、BX、CX、DX、SP等。用于存放操作数和各种地址信息。SP是堆栈指针，用于指示栈顶的地址。
  - 程序状态字寄存器：保留由算数逻辑运算指令或测试指令的结果而建立的各种状态信息。如溢出标志(OF)、符号标志(FS)、零标志(ZF)、进位标志(CF)等。
  - 位移器：对操作数或者结果进行位移运算。
  - 计数器：控制乘除运算的操作步数。
- 控制器：控制器的基本功能是执行指令，每条指令的执行是由控制器发生的一组微操作实现的。**分为硬布线控制器和微程序控制器**
  - 程序计数器(PC)：用于指出下一条指令在主存的存放地址。有自增功能
  - 指令寄存器(IR)：用于保存当前正在执行的那条指令
  - 指令译码器：仅对操作码字段进行译码，向控制器提供特定的操作信号
  - 存储器地址寄存器：用于存放所要访问的主存单元的地址
  - 存储器数据寄存器：用于存放向主存写入的信息或从主存中读出的信息
  - 时序系统：用于产生各种时序的信号，由统一时钟(CLOCK)分频得到
  - 为操作信号发生器：根据IR、PSW的内容及时序信号，产生控制整个计算机系统所需的各种控制信号，其结构有组合逻辑型和存储逻辑型

CPU寄存器可以分为两大类：
- 用户可见(可编程)：通用寄存器组、程序状态寄存器
- 用户不可见(对用户透明)：存储器地址寄存器、存储器数据寄存器、指令寄存器

# 指令执行过程


### 指令周期

指令周期由若干机器周期组成，一个机器周期又包含若干时钟周期。每个指令周期内机器周期数可以不等，每个机器周期内的节拍数也可以不等。

一个完整的指令周期包括**取指周期、间址周期、执行周期、中断周期**，这是四个机器周期

这四个机器周期都有CPU访存操作。取指周期为了取指令，间址周期为了取有效地址，执行周期为了取操作数，中断周期为了保存程序断点。

为了区别不同的周期，在CPU内部设置四个标志触发器。FE(取指)、IND(间址)、EX(执行)、INT(中断)

**中断周期的进栈操作是将SP-1**

### 指令周期的数据流
- 取指周期：根据PC中的内容从主存中取出指令代码并存放在IR中。

  PC->MAR->地址总线->主存

  CU发出控制信号->控制总线->主存

  主存->数据总线->MDR->IR

  CU发出读命令->PC内容加1

![取指周期数据流](../jz_picture/5/取指周期数据流.png)

- 间址周期：取操作数有效地址。
  
  Ad(IR)(或MDR)->MAR->地址总线->主存

  CU发出读命令->控制总线->主存

  主存->数据总线->MDR(存放操作数的有效地址)

![一次间址周期数据流](../jz_picture/5/一次性间址周期数据流.png)

- 执行周期：根据IR中的指令字的操作码和操作数通过ALU操作产生结果。
- 中断周期：处理中断请求(在条指令执行结束相应中断请求)。

  CU控制将SP-1，SP->MAR->地址总线->主存

  CU发出写命令->控制总线->主存

  PC->MDR->数据总线->主存(程序断点存入主存)

  CU(中断服务程序入口地址)->PC

![中断周期数据流](../jz_picture/5/中断周期数据流.png)

### 指令执行方案

- 单指令周期：所有指令都选用相同的执行时间来执行。指令周期取决于执行时间最长的指令的执行时间。会降低整个系统的运行速度
- 多指令周期：不同类型的指令选用不同的执行步骤来完成。指令之间串行执行，即下一条指令只能在该指令执行结束后执行。
- 流水线方案：指令之间并行执行，追求的目标是了力争在每个时钟脉冲周期完成一条指令的执行过程。这种方案通过在每个时钟周期启动每一条指令，尽量让多条指令同时运行，但各自处在不同的执行步骤中。

# 数据通路的基本功能和基本结构

### 数据通路的功能

数据在功能部件之间传送的路径称为数据通路.数据通路的功能是实现CPU内部的运算器与寄存器即寄存器之间的数据交换。

### 数据通路的基本结构

- CPU内部单总线方式。将所有寄存器的输入端和输出端连接到一条公共通路上。
- CPU内部三总线方式。将所有寄存器的输入端和输出端都连接到多条公共通路上。
- 专用数据通路方式。根据指令执行过程中的数据和地址的流动方向安排连接线路，避免使用共享的总线，性能较高，但硬件量大。
  
**内部总线是指同一部件，系统总线是指同一台计算机系统的各部件**

- 寄存器之间的数据传送：通过CPU内部总线完成。以PC寄存器为例，把PC内容送至MAR
  
  PC->Bus    PCout有效，PC内容送总线
  
  Bus->MAR   MARin有效，总线内容送MAR

- 主存与CPU之间的数据传送：也要借助CPU内部总线完成，以CPU从主存读取指令为例

  PC->Bus->MAR    PCout和MARin有效，现行指令地址->MAR

  1->R            CU发出读命令

  MEM(MAR)->MDR   MDRin有效

  MDR->Bus->IR    MDRout和IRin有效，现行指令->IR
  
- 执行算数或逻辑运算：**ALU本身没有内部存储功能的电路，执行加法运算，相加的两个数必须在ALU的两个输入端同时有效。**先讲一个操作数经CPU内部总线送入暂存器Y保存，Y的内容在ALU的左输入端始终有效，再将另一个操作数经总线直接送到ALU的右输入端。运算结果暂存在暂存器Z中。

  Ad(IR)->Bus->MAR    MDRout和MARin有效

  1->R                CU发出读命令

  MEM->数据线->MDR    操作数从存储器->数据线->MDR

  MDR->Bus->Y         MDRout和Yin有效，操作数->Y

  (ACC)+(Y)->Z        ACCout和ALUin有效，CU向ALU发出加命令，结果->Z

  Z->ACC              Zout和ACCin有效，结果->ACC

![内部总线](../jz_picture/5/内部总线.png)

# 控制器的功能和工作原理

### 控制器的功能和结构

控制器的主要功能：
- 从主存中取出一条指令，并指出下一条指令在主存中的位置
- 对指令进行译码或测试，产生相应的操作控制信号，以便启动规定的动作
- 指挥并控制CPU、主存、输入和输出设备之间的数据流动方向

控制器可分为硬布线控制器和微程序控制器

### 硬布线控制器

基本原理：根据指令的要求、当前的时序以及外部和内部的状态，按时间的顺序发送一系列微操作控制信号。由组合逻辑电路和触发器构成，又叫组合逻辑控制器。

CU的输入信号来源：
- 经指令译码器译码产生的指令信息。
- 时序系统产生的机器周期信号和节拍信号。
- 来自执行单元的反馈信息，即标志。
- 来自系统总线的控制信号，如中断请求、DMA请求

硬布线控制器的时序系统：
- 时钟周期
- 机器周期：所有指令执行过程中的一个基准时间。访问一次存储器的时间是固定的，因此通常以存取周期作为基准时间，即内存中读取一个指令字的最短时间作为机器周期。
- 指令周期
- 微操作命令分析

一条指令主要分为三个工作周期
- 取指周期
```
PC -> MAR      现行指令地址->MAR
1 -> R         命令存储器读
M(MAR) -> MDR  现行指令从存储器中读至MDR
MDR -> IR      现行指令->IR
OP(IR) -> CU   指令的操作码->CU译码
(PC)+1 -> PC   形成下一条指令的地址
```
- 间址周期
```
Ad(IR) -> MAR  将指令字中的地址码(形式地址)->MAR
1 -> R         命令存储器读
M(MAR) -> MDR  将有效地址从存储器读至MDR
```
- 执行周期

CPU的控制方式：控制单元控制一条指令执行的过程，实质上是依次执行一个确定的微操作序列的过程
- 同步控制方式：系统有一个时钟，所有的控制信号均来自这个统一的时钟信号。以最长的微操作序列和最繁琐的微操作作为基准。
- 异步控制方式：不存在基准时标信号，各部件按自身固有的速度工作，通过应答方式进行联络。
- 联合控制方式：介于同步和异步之间的折中。

### 微程序控制器
微程序设计思想就是将每条机器指令编写成一个微程序，每个微程序包含若干微指令，每条伪指令对应一个或几个微操作命令。
- 微命令与微操作：一条机器指令可以分解成一个微操作序列，这些微操作是计算机中最基本的、不可再分解的操作。将控制部件向执行部件发出的各种控制命令称为微命令，它是构成控制序列的最小单位。微命令是微操作的控制信号，微操作是微命令的执行过程。(在组合逻辑控制器中也存在微命令与微操作这两个概念)
- 微指令与微周期：微指令是若干微命令的集合。一条微指令通常包含两大部分信息：操作控制字段(位操作码字段)；顺序控制字段(微地址码字段)
- 主存储器与控制存储器：主存储器用来存放数据和程序，在CPU外部，由RAM实现。控制存储器用于存放微程序，在CPU内部，由ROM实现
- 程序与微程序：程序是指令的有序集合，微程序是微指令的有序集合。一条指令的功能由一段微程序来实现。

微指令的编码方式
- 直接编码方式：无需进行译码，微指令的为命令字段中每位都代表一个微命令。优点：简单，直观，执行速度快，操作并行性好。缺点：微指令字长过长，n个微命令就要操作字段有n位。
- 字段直接编码方式：将微指令的微命令字段分成若干小字段，把互斥性微命令组合在同一字段中，把相容性微指令组合在不同字段中。原则
  - 互斥性微命令分在同一段内，相容性微命令分在不同段内
  - 每个小段中包含的信息位不能太多，否则将增加译码线路的复杂性和译码时间
  - 一般每个小段还要留出一个状态，表示本字段不发出任何微命令。因此，当某字段的长度为3时，最多只能表示7个互斥的命令，通常用000表示不操作。
  - 字段间接编码方式：一个字段的某些微命令需由另一个字段中的某些微命令来解释。


微指令的地址形成方式：
- 直接由微指令的下地址字段指出。又称断定方式
- 根据机器指令的操作码形成。机器指令取至指令寄存器后，微指令的地址由操作码经微地址形成部件形成。

第一条微指令的地址可由专门的硬件电路产生，也可由外部直接向CMAR输入微指令的地址，这个地址即为取指周期微程序的入口地址。

微指令的格式
- 水平型微指令：直接编码、字段直接编码、字段间接编码和混合编码都属于水平型微指令。指令字中的一位对应一个控制信号，有输出时为1，否则为0.一条水平型微指令定义并执行几种并行的基本操作。优点是为程序短，执行速度快；缺点是微指令长，编写微程序较麻烦
- 垂直型微指令：采用类似机器指令的方式，设置微操作码字段。基本指令格式为微操作码-目的地址-源地址。垂直型微指令指令格式的优点是微指令短、简单、规整；缺点是微程序长，执行速度慢，工作效率低
- 混合型微指令：在垂直型的基础上增加一些不太复杂的并行操作。

|对比项目|微程序控制器|硬布线控制器|
|-----|-----|-----|
|工作原理|为操作控制信号以微程序的形式存放在控制存储器中，执行指令时读出即可|微操作控制信号由组合逻辑电路根据当前的指令码、状态和时序，即使产生|
|执行速度|慢|快|
|规整性|较规整|繁琐、不规整|
|应用场合|CISC CPU|RISC CPU|
|易扩展性|易扩充修改|困难|